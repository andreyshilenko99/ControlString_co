<!DOCTYPE html>
{% load leaflet_tags %}
{% load geojson_tags %}

<html>
<head>


    <title>Main page</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <meta charset=utf-8>

    <link rel="stylesheet" href="/static/styles.css"/>

    {% leaflet_js plugins="ALL" %}
    {% leaflet_css plugins="ALL" %}
    {% leaflet_js %}
    {% leaflet_css %}
    {% csrf_token %}

</head>
<body>
<div class="everything">
    <div class="map-info" style="margin: 1%">

        <div class="row">
            <div class="col-8 ">
                <div class="map-box" style="height: 70vh">
                    <div class="row" style="margin: 1%">
                        <form action="menu" method='GET'>
                            <button class="button-blue"> Меню</button>
                        </form>
                        <form action="main" method='GET'>
                            <button class="button-blue"> Главная</button>
                        </form>
                        <form action="journal" method='GET'>
                            <button class="button-blue"> Журнал</button>
                        </form>
                        <form action="configuration" method='GET'>
                            <button class="button-blue"> Конфигуратор</button>
                        </form>

                        <!--                        <form action="journal">-->
                        <!--                        <input type="submit" value="Журнал" />-->
                        <!--                        </form>-->
                    </div>
                    <div class="leaflet-container" style="border: 0.5vh solid #dfee99">

                        {% leaflet_map "map" callback="window.map_init_basic" %}
                    </div>


                </div>
                <div class="information-bottom" style="height: 25vh; margin-top: 1%; border: 0.5vh solid #dfee99">

                    Инфо по последним засечкам

                </div>

            </div>
            <div class="col-4">
                <div class="strizhes-all" style="height: 60vh; border: 0.5vh solid #dfee99">
                    <div class="strizh" style="margin-left: 5%;margin-top: 1%">
                        <div class="row">
                            <h3>
                                Все Стрижи
                            </h3>
                        </div>
                        <div class="strizh-for-all">
                            <div class="row">
                                <form action='butt_skan_all' method='GET'>
                                    <button class="button-green" type='submit'> Сканирование</button>
                                </form>
                                <form action='butt_glush_all' method='GET'>
                                    <button class="button-green">Глуш.</button>
                                </form>
                                <form action='butt_gps_all' method='GET'>
                                    <button class="button-green"> GPS глуш.</button>
                                </form>
                                <form action='butt_ku_all' method='GET'>
                                    <button class="button-green">КУ глуш.</button>
                                </form>
                            </div>
                        </div>
                        <div class="row" style="margin-top: 2%">
                            <h3>
                                <form action="choose_nomer_strizha" method="post">
                                    {% csrf_token %}
                                    Стриж #
                                    <input type="number" style="width: 15%" name="nomer_strizha"
                                           placeholder={{ nomer }}>
                                    <input type="submit" value="ввод">
                                </form>
                            </h3>
                            <!--                            <form action="update_nomer_strizha" method="get">-->
                            <!--                                upd {{  nomer }}-->
                            <!--                                <input type="submit" value="ввод">-->
                            <!--                            </form>-->

                        </div>
                        <div class="strizh-each">
                            <div class="row">
                                <form action='butt_skan' method='GET'>
                                    <button class="button-green" type='submit'> Сканирование</button>
                                </form>
                                <form action='butt_glush' method='GET'>
                                    <button class="button-green">Глуш.</button>
                                </form>
                                <form action='butt_gps' method='GET'>
                                    <button class="button-green"> GPS глуш.</button>
                                </form>
                                <form action='butt_ku' method='GET'>
                                    <button class="button-green">КУ глуш.</button>
                                </form>
                            </div>
                        </div>

                    </div>

                </div>
                <div class="information-bottom" style="height: 37vh; margin-top: 1%; border: 0.5vh solid #dfee99">
                    Служебка, Uniping, АГМ, логи
                    <!--                    <a href="http://192.168.2.51/termo.html"> Термодатчики</a>-->
                    <!--                    <a href="http://192.168.2.51/curdet.html"> Датчик дыма </a>-->
                    <!--                    <a href="http://192.168.2.51/rh.html"> Датчик влажности </a>-->
                    <!--                    <a href="http://192.168.2.51/log.html"> Журнал </a>-->

                    <form action='functioning_loop' method='GET'>
                        <h5> Температура: {{ temperature }}&deg,</h5>
                        <h5> Влажность: {{ humidity }}%,</h5>
                        <!--                        <h5>Температура датчика влажности: {{humidity_temp}}&deg</h5>-->
                        <h5> Состояние: {{ weather_state }}</h5>
                        <h5> Комплекс {{ complex_state }} </h5>

                        <h5>
                        </h5>
                    </form>
                    <div class="box-scroll">
                        <form action='show_logs' method='GET'>

                            {% for el in logs_list %}
                            {{ el }} <br>
                            {% endfor %}
                        </form>
                    </div>

                    <div class="row" style="margin: 2%;">
                        <form action='turn_on_bp' method='GET'>
                            <button class="button-green-small">Включение комплекса</button>
                        </form>
                        <form action='turn_off_bp' method='GET'>
                            <button class="button-red">Выключение комплекса</button>
                        </form>
                    </div>


                </div>
            </div>
        </div>
    </div>


</div>

<script>
    function map_init_basic(map, options) {

        //      30.45331835746765,
        //      60.014732785555395

        //     30.453994274139404,
        //     60.01450757958334

        //     30.453983545303345,
        //     60.01494726600732

        //    30.452492237091064,
        //    60.0143359930511

        var layerGroup = L.layerGroup().addTo(map);

        function refreshMarkers() {

            $.getJSON('/geo/data/', function (data) {
                var logoMarkerStyle = L.Icon.extend({
                    options: {
                        iconSize: [45, 45],
                        iconAnchor: [38, 86],
                        popupAnchor: [0, -80]
                    }
                });
                // var logoMarker = new logoMarkerStyle({iconUrl: 'https://image.flaticon.com/icons/png/512/215/215767.png'});
                var logoMarker = new logoMarkerStyle({iconUrl: 'https://image.flaticon.com/icons/png/512/215/215736.png'});
                var len_arr = data.features.length
                console.log(len_arr)
                for (let step = 0; step < len_arr; step++) {
                    data.features[step].geometry = {}
                    data.features[step].geometry.coordinates = [0, 0]
                    data.features[step].geometry.type = "Point"
                    data.features[step].geometry.coordinates[0] = data.features[step].properties.lon
                    data.features[step].geometry.coordinates[1] = data.features[step].properties.lat
                    data.features[step].properties = {}
                    // L.geoJson(data, {icon: logoMarker}).addTo(map);
                    L.marker([data.features[step].geometry.coordinates[1], data.features[step].geometry.coordinates[0]],
                        {icon: logoMarker}).addTo(layerGroup);
                }
            });
            layerGroup.clearLayers();
        }
        refreshMarkers()
        setInterval(refreshMarkers, 5000);

        $.getJSON('/geo/strizh_view/', function (data) {
            var logoMarkerStyle = L.Icon.extend({
                options: {
                    iconSize: [85, 90],
                    iconAnchor: [38, 86],
                    popupAnchor: [0, -80]
                }
            });
            var logoMarker = new logoMarkerStyle({
                iconUrl: 'https://cdn.iconscout.com/icon/free/png-256/antenna-' +
                    'electronics-signal-technology-wifi-radiowaves-6-3098.png'
            });
            var len_arr = data.features.length
            console.log(data)
            console.log(len_arr)
            for (let step = 0; step < len_arr; step++) {
                data.features[step].geometry = {}
                data.features[step].geometry.coordinates = [0, 0]
                data.features[step].geometry.type = "Point"
                data.features[step].geometry.coordinates[0] = data.features[step].properties.lon
                data.features[step].geometry.coordinates[1] = data.features[step].properties.lat
                data.features[step].properties = {}
                // L.geoJson(data, {icon: logoMarker}).addTo(map);
                L.marker([data.features[step].geometry.coordinates[1], data.features[step].geometry.coordinates[0]], {icon: logoMarker}).addTo(map);
                let sector1 = L.sector({
                    center: [data.features[step].geometry.coordinates[1], data.features[step].geometry.coordinates[0]],
                    innerRadius: 0,
                    outerRadius: 500,
                    startBearing: 230,
                    endBearing: 250,
                    color: 'red'
                });

                let arc1 = L.arc({
                    center: [data.features[step].geometry.coordinates[1], data.features[step].geometry.coordinates[0]],
                    radius: 500,
                    color: 'pink',
                    startBearing: 0,
                    endBearing: 360,

                });

                map.addLayer(sector1)
                map.addLayer(arc1)
            }

            console.log(data);

        })

        $.getJSON('/geo/sector_view/', function (data) {

            var len_arr = data.features.length
            console.log(data)
            console.log(len_arr)
            for (let step = 0; step < len_arr; step++) {
                let sector1 = L.sector({
                    center: [data.features[step].properties.center_lat, data.features[step].properties.center_lon],
                    innerRadius: data.features[step].properties.innerRadius,
                    outerRadius: data.features[step].properties.outerRadius,
                    startBearing: data.features[step].properties.startBearing,
                    endBearing: data.features[step].properties.endBearing,
                    color: data.features[step].properties.color
                });

                map.addLayer(sector1)
            }
        })

    }


</script>

</body>
</html>
